{"version":3,"file":"browser.es5.js","sources":["base.ts","browser.ts"],"sourcesContent":["export enum Orientation {\n  TOP_LEFT = 1,         // Horizontal (Default)\n  TOP_RIGHT = 2,        // Mirror Horizontal\n  BOTTOM_RIGHT  = 3,    // Rotate 180\n  BOTTOM_LEFT = 4,      // Mirror vertical\n  LEFT_TOP = 5,         // Mirror horizontal and rotate 270 CW\n  RIGHT_TOP = 6,        // Rotate 90 CW\n  RIGHT_BOTTOM = 7,     // Mirror horizontal and rotate 90 CW\n  LEFT_BOTTOM = 8,      // Rotate 270 CW\n}\n","import { Orientation } from \"./base\";\n\nexport { Orientation };\n\nconst fileReaderMap = new WeakMap<Blob, FileReader>();\n\nexport async function getOrientation(input: ArrayBuffer | File | Blob) {\n  if (!(input instanceof ArrayBuffer || input instanceof Blob)) {\n    throw new TypeError(\"Unexpected input type\");\n  }\n\n  let offset = 0;\n  const totalBytes = getSize(input);\n\n  // Signature validation\n  {\n    const bufSignature = await readBytes(input, offset, 4);\n    offset += bufSignature.byteLength;\n\n    const signature = new DataView(bufSignature);\n    const head = signature.getUint16(0);\n    const tail = signature.getUint16(2);\n\n    // Check EXIF SOI first\n    if (head === 0xffd8) {\n      // This is EXIF structure. handle application markers\n      let bufMarker = bufSignature.slice(2);\n      do {\n        const marker = (new DataView(bufMarker)).getUint16(0);\n        if (marker === 0xffe1) { // APP1 Marker - EXIF, or Adobe XMP\n          // We must verify that marker segment to avoid conflict.\n          // Adobe XMP uses APP1 space too!\n          const bufSegmentHead = await readBytes(input, offset, 8);\n          const segmentHead = new DataView(bufSegmentHead);\n\n          const isEXIF = segmentHead.getUint16(2) === 0x4578\n            && segmentHead.getUint16(4) === 0x6966\n            && segmentHead.getUint16(6) === 0x0000;\n\n          if (isEXIF) {\n            offset += bufSegmentHead.byteLength;\n            break;\n          } else {\n            const segmentSize = segmentHead.getUint16(0);\n            offset += segmentSize;\n          }\n        } else if (0xffe0 <= marker && marker <= 0xffef) { // Other JPEG application markers\n          // e.g. APP0 Marker (JFIF), APP2 Marker (FlashFix Extension, ICC Color Profile), Photoshop IRB...\n          // @see http://www.ozhiker.com/electronics/pjmt/jpeg_info/app_segments.html\n\n          // Just skip. we don't need them\n          const bufSegmentSize = await readBytes(input, offset, 2);\n          offset += bufSegmentSize.byteLength;\n\n          const segmentSize = (new DataView(bufSegmentSize)).getUint16(0);\n          const remainingBytes = segmentSize - 2;\n          offset += remainingBytes;\n        } else { // If any other JPEG marker segment was found, skip entire bytes.\n          // Please refer Table B.1 â€“ Marker code assignments from\n          // https://www.w3.org/Graphics/JPEG/itu-t81.pdf\n          return Orientation.TOP_LEFT;\n        }\n\n        bufMarker = await readBytes(input, offset, 2);\n        offset += bufMarker.byteLength;\n      } while (offset < totalBytes);\n    } else if ((head === 0x4949 && tail === 0x2a00) || (head === 0x4d4d && tail === 0x002a)) {\n      // yeah this is TIFF header\n      // reset offset cursor.\n      offset = 0;\n    } else { // This stream is not a JPEG file. Skip.\n      return Orientation.TOP_LEFT;\n    }\n  }\n\n  const bufTIFFHeader = await readBytes(input, offset, 8);\n\n  const tiffHeader = new DataView(bufTIFFHeader);\n  const isLittleEndian = tiffHeader.getUint16(0) === 0x4949;\n  const ifdOffset = tiffHeader.getUint32(4, isLittleEndian);\n\n  // move cursor to IFD block\n  offset += ifdOffset;\n\n  const bufFieldCount = await readBytes(input, offset, 2);\n  offset += bufFieldCount.byteLength;\n\n  let fieldCount = (new DataView(bufFieldCount)).getUint16(0, isLittleEndian);\n  while (fieldCount-- > 0) {\n    const bufField = await readBytes(input, offset, 12);\n    offset += bufField.byteLength;\n    const field = new DataView(bufField);\n\n    const tagId = field.getUint16(0, isLittleEndian);\n    if (tagId === 0x112) { // Orientation Tag\n      const value = (new DataView(bufField.slice(8, 12))).getUint16(0, isLittleEndian);\n\n      if (1 <= value && value <= 8) {\n        return value as Orientation;\n      } else {\n        throw new Error(\"Unexpected Orientation Value\");\n      }\n    }\n  }\n\n  return Orientation.TOP_LEFT;\n}\n\nfunction readBytes(input: Blob | ArrayBuffer, offset: number, size: number): Promise<ArrayBuffer> {\n  if (input instanceof Blob) {\n    return new Promise<ArrayBuffer>((resolve, reject) => {\n      let reader = fileReaderMap.get(input)!;\n\n      if (!reader) {\n        reader = new FileReader();\n        fileReaderMap.set(input, reader);\n      }\n\n      reader.onerror = (e) => {\n        reader.onerror = null;\n        reader.onload = null;\n        reject(e);\n      };\n\n      reader.onload = () => {\n        reader.onerror = null;\n        reader.onload = null;\n\n        resolve(reader.result as ArrayBuffer);\n      };\n\n      reader.readAsArrayBuffer(\n        input.slice(offset, offset + size),\n      );\n    });\n  }\n\n  return Promise.resolve(input.slice(offset, offset + size));\n}\n\nfunction getSize(input: Blob | ArrayBuffer) {\n  return input instanceof Blob ?\n    input.size :\n    input.byteLength;\n}\n"],"names":["Orientation"],"mappings":"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"}