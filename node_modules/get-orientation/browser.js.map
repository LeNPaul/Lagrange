{"version":3,"file":"browser.js","sources":["base.ts","browser.ts"],"sourcesContent":["export enum Orientation {\n  TOP_LEFT = 1,         // Horizontal (Default)\n  TOP_RIGHT = 2,        // Mirror Horizontal\n  BOTTOM_RIGHT  = 3,    // Rotate 180\n  BOTTOM_LEFT = 4,      // Mirror vertical\n  LEFT_TOP = 5,         // Mirror horizontal and rotate 270 CW\n  RIGHT_TOP = 6,        // Rotate 90 CW\n  RIGHT_BOTTOM = 7,     // Mirror horizontal and rotate 90 CW\n  LEFT_BOTTOM = 8,      // Rotate 270 CW\n}\n","import { Orientation } from \"./base\";\n\nexport { Orientation };\n\nconst fileReaderMap = new WeakMap<Blob, FileReader>();\n\nexport async function getOrientation(input: ArrayBuffer | File | Blob) {\n  if (!(input instanceof ArrayBuffer || input instanceof Blob)) {\n    throw new TypeError(\"Unexpected input type\");\n  }\n\n  let offset = 0;\n  const totalBytes = getSize(input);\n\n  // Signature validation\n  {\n    const bufSignature = await readBytes(input, offset, 4);\n    offset += bufSignature.byteLength;\n\n    const signature = new DataView(bufSignature);\n    const head = signature.getUint16(0);\n    const tail = signature.getUint16(2);\n\n    // Check EXIF SOI first\n    if (head === 0xffd8) {\n      // This is EXIF structure. handle application markers\n      let bufMarker = bufSignature.slice(2);\n      do {\n        const marker = (new DataView(bufMarker)).getUint16(0);\n        if (marker === 0xffe1) { // APP1 Marker - EXIF, or Adobe XMP\n          // We must verify that marker segment to avoid conflict.\n          // Adobe XMP uses APP1 space too!\n          const bufSegmentHead = await readBytes(input, offset, 8);\n          const segmentHead = new DataView(bufSegmentHead);\n\n          const isEXIF = segmentHead.getUint16(2) === 0x4578\n            && segmentHead.getUint16(4) === 0x6966\n            && segmentHead.getUint16(6) === 0x0000;\n\n          if (isEXIF) {\n            offset += bufSegmentHead.byteLength;\n            break;\n          } else {\n            const segmentSize = segmentHead.getUint16(0);\n            offset += segmentSize;\n          }\n        } else if (0xffe0 <= marker && marker <= 0xffef) { // Other JPEG application markers\n          // e.g. APP0 Marker (JFIF), APP2 Marker (FlashFix Extension, ICC Color Profile), Photoshop IRB...\n          // @see http://www.ozhiker.com/electronics/pjmt/jpeg_info/app_segments.html\n\n          // Just skip. we don't need them\n          const bufSegmentSize = await readBytes(input, offset, 2);\n          offset += bufSegmentSize.byteLength;\n\n          const segmentSize = (new DataView(bufSegmentSize)).getUint16(0);\n          const remainingBytes = segmentSize - 2;\n          offset += remainingBytes;\n        } else { // If any other JPEG marker segment was found, skip entire bytes.\n          // Please refer Table B.1 â€“ Marker code assignments from\n          // https://www.w3.org/Graphics/JPEG/itu-t81.pdf\n          return Orientation.TOP_LEFT;\n        }\n\n        bufMarker = await readBytes(input, offset, 2);\n        offset += bufMarker.byteLength;\n      } while (offset < totalBytes);\n    } else if ((head === 0x4949 && tail === 0x2a00) || (head === 0x4d4d && tail === 0x002a)) {\n      // yeah this is TIFF header\n      // reset offset cursor.\n      offset = 0;\n    } else { // This stream is not a JPEG file. Skip.\n      return Orientation.TOP_LEFT;\n    }\n  }\n\n  const bufTIFFHeader = await readBytes(input, offset, 8);\n\n  const tiffHeader = new DataView(bufTIFFHeader);\n  const isLittleEndian = tiffHeader.getUint16(0) === 0x4949;\n  const ifdOffset = tiffHeader.getUint32(4, isLittleEndian);\n\n  // move cursor to IFD block\n  offset += ifdOffset;\n\n  const bufFieldCount = await readBytes(input, offset, 2);\n  offset += bufFieldCount.byteLength;\n\n  let fieldCount = (new DataView(bufFieldCount)).getUint16(0, isLittleEndian);\n  while (fieldCount-- > 0) {\n    const bufField = await readBytes(input, offset, 12);\n    offset += bufField.byteLength;\n    const field = new DataView(bufField);\n\n    const tagId = field.getUint16(0, isLittleEndian);\n    if (tagId === 0x112) { // Orientation Tag\n      const value = (new DataView(bufField.slice(8, 12))).getUint16(0, isLittleEndian);\n\n      if (1 <= value && value <= 8) {\n        return value as Orientation;\n      } else {\n        throw new Error(\"Unexpected Orientation Value\");\n      }\n    }\n  }\n\n  return Orientation.TOP_LEFT;\n}\n\nfunction readBytes(input: Blob | ArrayBuffer, offset: number, size: number): Promise<ArrayBuffer> {\n  if (input instanceof Blob) {\n    return new Promise<ArrayBuffer>((resolve, reject) => {\n      let reader = fileReaderMap.get(input)!;\n\n      if (!reader) {\n        reader = new FileReader();\n        fileReaderMap.set(input, reader);\n      }\n\n      reader.onerror = (e) => {\n        reader.onerror = null;\n        reader.onload = null;\n        reject(e);\n      };\n\n      reader.onload = () => {\n        reader.onerror = null;\n        reader.onload = null;\n\n        resolve(reader.result as ArrayBuffer);\n      };\n\n      reader.readAsArrayBuffer(\n        input.slice(offset, offset + size),\n      );\n    });\n  }\n\n  return Promise.resolve(input.slice(offset, offset + size));\n}\n\nfunction getSize(input: Blob | ArrayBuffer) {\n  return input instanceof Blob ?\n    input.size :\n    input.byteLength;\n}\n"],"names":["Orientation"],"mappings":"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"}